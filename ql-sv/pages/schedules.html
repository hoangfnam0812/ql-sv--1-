<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th·ªùi kh√≥a bi·ªÉu - H·ªá th·ªëng QLSV</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

</head>
<body>
    <div class="dashboard">
        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-brand">
                <h3>üéì QLSV</h3>
                <p>Qu·∫£n l√Ω Sinh vi√™n</p>
            </div>
            <ul class="sidebar-menu">
                <li><a href="./dashboard.html"><span></span> Dashboard</a></li>
                <li><a href="./students.html"><span></span> Qu·∫£n l√Ω Sinh vi√™n</a></li>
                <li><a href="./grades.html"><span></span> Qu·∫£n l√Ω ƒêi·ªÉm</a></li>
                <li><a href="./announcements.html"><span></span> Th√¥ng b√°o</a></li>
                <li><a href="./schedules.html" class="active" style="font-weight: bold;"><span></span> Th·ªùi kh√≥a bi·ªÉu</a></li>
                <li><a href="./accounts.html"><span></span> Qu·∫£n l√Ω T√†i kho·∫£n</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">
                        ‚ò∞
                    </button>
                    <h2>Th·ªùi kh√≥a bi·ªÉu</h2>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <span class="user-name" id="userName">Admin</span>
                    </div>
                    <button class="btn-logout" onclick="handleLogout()">ƒêƒÉng xu·∫•t</button>
                </div>
            </header>

            <div class="content">
                <!-- Schedule Table -->
                <div class="table-container">
                    <div class="table-header">
                        <h3>L·ªãch h·ªçc trong tu·∫ßn</h3>
                        <button class="btn btn-primary" onclick="openAddModal()"> Th√™m l·ªãch h·ªçc</button>
                    </div>

                    <div class="schedule-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Th·ª©</th>
                                    <th>L·ªõp</th>
                                    <th>M√¥n h·ªçc</th>
                                    <th>Gi·∫£ng vi√™n</th>
                                    <th>Ph√≤ng</th>
                                    <th>Th·ªùi gian</th>
                                    <th>H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody">
                                <tr><td colspan="7" class="text-center">ƒêang t·∫£i...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Schedule by Day -->
                <div class="table-container mt-3">
                    <div class="table-header">
                        <h3>L·ªãch h·ªçc theo th·ª©</h3>
                        <select id="dayFilter" class="btn" style="padding: 8px 15px; cursor: pointer;">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="Th·ª© 2">Th·ª© 2</option>
                            <option value="Th·ª© 3">Th·ª© 3</option>
                            <option value="Th·ª© 4">Th·ª© 4</option>
                            <option value="Th·ª© 5">Th·ª© 5</option>
                            <option value="Th·ª© 6">Th·ª© 6</option>
                            <option value="Th·ª© 7">Th·ª© 7</option>
                        </select>
                    </div>

                    <div id="scheduleByDay" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                        <!-- L·ªãch h·ªçc s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Th√™m/S·ª≠a L·ªãch h·ªçc -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Th√™m l·ªãch h·ªçc</h3>
                <button class="close-modal" onclick="closeScheduleModal()">√ó</button>
            </div>

            <form id="scheduleForm">
                <input type="hidden" id="scheduleIdHidden">
                <input type="hidden" id="isEditMode" value="false">

                <div class="form-group">
                    <label for="class">L·ªõp *</label>
                    <input type="text" id="class" placeholder="VD: IT01" required>
                </div>

                <div class="form-group">
                    <label for="subject">M√¥n h·ªçc *</label>
                    <input type="text" id="subject" placeholder="VD: L·∫≠p tr√¨nh Web" required>
                </div>

                <div class="form-group">
                    <label for="teacher">Gi·∫£ng vi√™n *</label>
                    <input type="text" id="teacher" placeholder="VD: TS. Nguy·ªÖn VƒÉn A" required>
                </div>

                <div class="form-group">
                    <label for="room">Ph√≤ng h·ªçc *</label>
                    <input type="text" id="room" placeholder="VD: A101" required>
                </div>

                <div class="form-group">
                    <label for="day">Th·ª© *</label>
                    <select id="day" required>
                        <option value="">-- Ch·ªçn th·ª© --</option>
                        <option value="Th·ª© 2">Th·ª© 2</option>
                        <option value="Th·ª© 3">Th·ª© 3</option>
                        <option value="Th·ª© 4">Th·ª© 4</option>
                        <option value="Th·ª© 5">Th·ª© 5</option>
                        <option value="Th·ª© 6">Th·ª© 6</option>
                        <option value="Th·ª© 7">Th·ª© 7</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="startTime">Gi·ªù b·∫Øt ƒë·∫ßu *</label>
                    <input type="time" id="startTime" required>
                </div>

                <div class="form-group">
                    <label for="endTime">Gi·ªù k·∫øt th√∫c *</label>
                    <input type="time" id="endTime" required>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeScheduleModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/validation.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        if (!Auth.requireAuth()) window.location.href = '../index.html';

        let allSchedules = [];
        let currentEditId = null;

        window.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadSchedules();
            
            document.getElementById('dayFilter').addEventListener('change', function() {
                renderScheduleByDay(this.value);
            });
        });

        function loadUserInfo() {
            const user = Auth.getCurrentUser();
            if (user) {
                document.getElementById('userName').textContent = user.fullName;
                document.getElementById('userAvatar').textContent = user.fullName.charAt(0).toUpperCase();
            }
        }

        function loadSchedules() {
            allSchedules = Storage.getSchedules() || [];
            renderScheduleTable(allSchedules);
            renderScheduleByDay('');
        }

        function renderScheduleTable(schedules) {
            const tbody = document.getElementById('scheduleTableBody');
            
            if (schedules.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Ch∆∞a c√≥ l·ªãch h·ªçc n√†o</td></tr>';
                return;
            }

            // S·∫Øp x·∫øp theo th·ª©
            const dayOrder = ['Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
            const sorted = [...schedules].sort((a, b) => {
                const dayCompare = dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day);
                if (dayCompare !== 0) return dayCompare;
                return a.startTime.localeCompare(b.startTime);
            });

            tbody.innerHTML = sorted.map(schedule => `
                <tr>
                    <td><strong>${schedule.day}</strong></td>
                    <td>${schedule.class}</td>
                    <td>${schedule.subject}</td>
                    <td>${schedule.teacher}</td>
                    <td>${schedule.room}</td>
                    <td>${schedule.startTime} - ${schedule.endTime}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-warning" onclick="openEditModal('${schedule.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSchedule('${schedule.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function renderScheduleByDay(filterDay) {
            const container = document.getElementById('scheduleByDay');
            let schedules = allSchedules;

            if (filterDay) {
                schedules = schedules.filter(s => s.day === filterDay);
            }

            if (schedules.length === 0) {
                container.innerHTML = '<div class="empty-state">Kh√¥ng c√≥ l·ªãch h·ªçc</div>';
                return;
            }

            // Nh√≥m theo th·ª©
            const groupedByDay = {};
            schedules.forEach(schedule => {
                if (!groupedByDay[schedule.day]) {
                    groupedByDay[schedule.day] = [];
                }
                groupedByDay[schedule.day].push(schedule);
            });

            container.innerHTML = Object.keys(groupedByDay).map(day => {
                const daySchedules = groupedByDay[day];
                return `
                    <div class="card">
                        <h4 style="margin-bottom: 15px; color: var(--primary-color);">${day}</h4>
                        ${daySchedules.map(s => `
                            <div class="schedule-item" style="background: var(--primary-color); margin-bottom: 10px;">
                                <strong>${s.subject}</strong><br>
                                <small>üè´ ${s.class} ‚Ä¢ üìç ${s.room}</small><br>
                                <small>üë®‚Äçüè´ ${s.teacher}</small><br>
                                <small>‚è∞ ${s.startTime} - ${s.endTime}</small>
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Th√™m l·ªãch h·ªçc';
            document.getElementById('isEditMode').value = 'false';
            Utils.resetForm('scheduleForm');
            Utils.openModal('scheduleModal');
        }

        function openEditModal(scheduleId) {
            const schedules = Storage.getSchedules() || [];
            const schedule = schedules.find(s => s.id === scheduleId);
            
            if (!schedule) {
                Utils.showAlert('Kh√¥ng t√¨m th·∫•y l·ªãch h·ªçc!', 'error');
                return;
            }

            currentEditId = scheduleId;
            document.getElementById('modalTitle').textContent = 'S·ª≠a l·ªãch h·ªçc';
            document.getElementById('isEditMode').value = 'true';
            
            document.getElementById('class').value = schedule.class;
            document.getElementById('subject').value = schedule.subject;
            document.getElementById('teacher').value = schedule.teacher;
            document.getElementById('room').value = schedule.room;
            document.getElementById('day').value = schedule.day;
            document.getElementById('startTime').value = schedule.startTime;
            document.getElementById('endTime').value = schedule.endTime;

            Utils.openModal('scheduleModal');
        }

        function closeScheduleModal() {
            Utils.closeModal('scheduleModal');
            Utils.resetForm('scheduleForm');
            currentEditId = null;
        }

        document.getElementById('scheduleForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const isEdit = document.getElementById('isEditMode').value === 'true';

            const formData = {
                id: isEdit ? currentEditId : Storage.generateId('TKB'),
                class: document.getElementById('class').value.trim(),
                subject: document.getElementById('subject').value.trim(),
                teacher: document.getElementById('teacher').value.trim(),
                room: document.getElementById('room').value.trim(),
                day: document.getElementById('day').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value
            };

            const validation = Validation.validateScheduleForm(formData);
            if (!validation.isValid) {
                Utils.showAlert(validation.errors.join('<br>'), 'error');
                return;
            }

            if (isEdit) {
                Storage.updateSchedule(currentEditId, formData);
                Utils.showAlert('C·∫≠p nh·∫≠t l·ªãch h·ªçc th√†nh c√¥ng!', 'success');
            } else {
                Storage.addSchedule(formData);
                Utils.showAlert('Th√™m l·ªãch h·ªçc th√†nh c√¥ng!', 'success');
            }

            closeScheduleModal();
            loadSchedules();
        });

        function deleteSchedule(scheduleId) {
            if (!Utils.confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªãch h·ªçc n√†y?')) return;
            
            Storage.deleteSchedule(scheduleId);
            Utils.showAlert('ƒê√£ x√≥a l·ªãch h·ªçc!', 'success');
            loadSchedules();
        }

        function handleLogout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) Auth.logout();
        }

        window.onclick = function(event) {
            const modal = document.getElementById('scheduleModal');
            if (event.target === modal) closeScheduleModal();
        };

        // Toggle Sidebar for Mobile
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        // Close sidebar when clicking overlay
        document.getElementById('sidebarOverlay').addEventListener('click', function() {
            toggleSidebar();
        });

        // Close sidebar when clicking a menu item on mobile
        if (window.innerWidth <= 768) {
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.addEventListener('click', function() {
                    const sidebar = document.querySelector('.sidebar');
                    const overlay = document.getElementById('sidebarOverlay');
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                });
            });
        }
    </script>
</body>
</html>
